---
title: ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚³ãƒžãƒ³ãƒ‰
topics: [Web] 
type: tech
emoji: ðŸ’›
published: true
---

## æ¦‚è¦

ä»•äº‹ã§webåˆ¶ä½œã‚’ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰=>ãƒãƒ¼ãƒ ç¢ºèªã®ãƒ•ãƒ­ãƒ¼ãŒå¢—ãˆã‚‹ã€‚
ãã†ã„ã£ãŸã¨ãã«ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã‚³ãƒžãƒ³ãƒ‰ã§è‡ªå‹•åŒ–ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚
ã—ã‹ã—å—è¨—ãƒ¡ã‚¤ãƒ³ã ã¨ftpä½¿ã‚ãªã„ã¨ã„ã‘ãªã‹ã£ãŸã‚Šã€sftpã ã£ãŸã‚Šã€aws s3ã«ãªã£ãŸã‚Šã—ã¦ã„ã‚ã„ã‚çŸ¥è¦‹ãŒãŸã¾ã£ãŸã®ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ‰‹æ®µã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

å¿…è¦ã«ãªã‚‹ã®ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ‚ç›¤ãŒå¤šã„ãŒã€çµ‚ç›¤ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã¤ã„ã¦è€ƒãˆã‚‹è„³å†…ã®ãƒªã‚½ãƒ¼ã‚¹ãŒãªã„ã“ã¨ãŒå¤§åŠãªãŸã‚ã“ã®ä½œæ¥­ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åºç›¤ã«æ¸ˆã¾ã›ã¦ãŠã„ãŸã»ã†ãŒã¶ãªã‚“ç„¡é›£ã§ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã€è‡ªå‹•åŒ–ã—ãªã„(æ‰‹å‹•ã§ã‚„ã‚‹)ã¨ã„ã†é¸æŠžãŒæ­£è§£ãªã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚

**â€»æ˜”ã«æ›¸ã„ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚å¤šã„ã®ã§ä»Šãã®ã¾ã¾å‹•ãã‹ã¯ã‚ã‹ã‚‰ãªã„ã€‚ã‚µãƒ¼ãƒãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šæ›¸ãã—ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã©ã¯å¿…ãšã™ã‚‹ã“ã¨ã€‚è‡ªåˆ†ãŒã‚‚ã—åŒã˜ã“ã¨ã™ã‚‹å ´åˆã¯ã“ã“ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã¨ã‚Šã‚ãˆãšã‚„ã£ã¦ã¿ã‚‹ã®ã§å‚è€ƒã«ãªã‚Œã°ã¨æ€ã£ã¦è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚**

ãŠå“æ›¸ã

- ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ftp
- node.jsã§sftp
- Makefileã§rsync(ssh)
- node.jsã§aws s3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ gzipãªã—
- node.jsã§aws s3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ gzipã‚ã‚Š
- gulp.js(ftp, sftp, aws s3)
## ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †

**ftpã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹(sftpã§ã‚‚ã§ãã‚‹èª¬ï¼Ÿ)**

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›´æ›¸ãã—ã¦ã‚‹ã®ã§.gitignoreã—ãŸã»ã†ãŒç„¡é›£



````bash
HOSTNAME=xxxxxxxx.co.jp/dir/
USERNAME=username
PASSWORD=password
SOURCE="ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª/"
DIST="ã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª/"

lftp -u $USERNAME,$PASSWORD $HOSTNAME -e "\
  mirror \
  --reverse \
  --delete \
  --verbose \
  -X .DS_Store \
  $SOURCE \
  $DIST; \
  exit"

````

**sftpã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
node.jsã§ä»¥ä¸‹ã®2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã€sftpconfig.jsã«è¨­å®šã‚’æ›¸ã„ã¦

`node sftp.js`

ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

host/passwordã‚’stfpconfig.jsã«åˆ†ã‘ã¦æ›¸ã„ã¦ã“ã£ã¡ã¯.gitignoreã™ã‚‹ã€‚

sftp.js


````javascript
const fs = require('fs');
const path = require('path');
const sftp = require('node-sftp-deploy');
const config = require('./sftpconfig')

sftp(config, ()=>{
  //Success Callback
});

````

sftpconfig.js


````javascript
module.exports = {
  "host": "xxxxxxxx.jp",
  "port": "22",
  "user": "user",
  "pass": "passsord",
  "remotePath": "/home/www/your-directory/public_html"
  "sourcePath": "./{local_dir}"
}


````

## sshä½¿ã£ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰(rsync)

ã“ã®ã‚±ãƒ¼ã‚¹ã¯nodeã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚’æ›¸ã„ãŸã¨ãã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¸€åº¦æ­¢ã‚ã¦ã€rsyncã—ã¦ã€ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã‚’è‡ªå‹•ã§ã‚„ã£ã¦ã„ãŸã¨ãã®ãƒ¡ãƒ¢ã€‚rsyncã®ã¿ã§ã‚ã‚Œã°ä¸€è¡Œã§ã§ãã‚‹ã¨æ€ã†ã®ã§ä¸‹ã«åˆ¥ã«åˆ†ã‘ãŸã‚‚ã®ã‚‚æ›¸ãã¾ã—ãŸã€‚

éµæƒ…å ±ã¯ .ssh/configã«æ›¸ã„ã¦ã‚ã‚‹æƒ³å®šã€‚

Makefile (hogeã¯sshã®configå)


````bash
deploy_production:
    #nodeã®ãƒ—ãƒ­ã‚»ã‚¹è½ã¨ã™ (option pm2ã§å®Ÿè¡Œã—ã—ã¦ã„ã—ã¦ã„ãŸã—ã¦ã„ãŸè½ã¨ã™)
    ssh hoge "source ~/.bash_profile && pm2 stop processname && pm2 deleteprocessname"
    #ec2ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(option ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚makefileã§ãƒ•ã‚©ãƒ«ãƒ€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’æ›¸ã„ãŸ)
    ssh hoge "make backup"
    #rsync
    rsync -aruzv local_dir/ hoge:~/server_dir

    #restart (option pm2ï½„ã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ)
    ssh hoge "source ~/.bash_profile && cd server_dir && pm2 start pm2config.json --env production"

````

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã ã‘ãªã‚‰ä»¥ä¸‹ã§ã§ãã‚‹èª¬


````bash
deploy:
    rsync -aruzv local_dir/ hoge:~/server_dir


````

## s3ãƒã‚±ãƒƒãƒˆã«ãƒ‡ãƒ—ãƒ­ã‚¤(éžgzipåœ§ç¸®)

s3config.jsonã«éµæƒ…å ±ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¹ãªã©ã‚’æ›¸ã„ã¦ã€s3deploy.jsã§å®Ÿè¡Œã€‚s3config.jsonã¯gitignoreãªã‚Šã§ä¿è­·
cloud frontãªã©ã§gzipé…ä¿¡ã™ã‚‹ã¨ãã¯ãã®ã¾ã¾ä¸Šã’ã¦ã„ã„ã¨æ€ã†ã®ã§éžgzipãƒãƒ¼ã‚¸ãƒ§ãƒ³

`node s3deploy.js`

ã§å®Ÿè¡Œ

s3config.json


````json
{
  "accessKeyId": "XYXYXYXYXYXYXYXYXYXYXY",
  "secretAccessKey": "aklfaSFDfFEgDgadgkRAFDAFl",
  "region": "ap-northeast-1",
  "bucket": "your.bucket.name",
  "path": "dist_path/",
  "src": "local_path/"
}

````

s3deploy.js


````javascript
const s3 = require('s3');
const path = require('path');
const s3config = require('./s3config.json')

// ã¾ãšã¯s3ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
const client = s3.createClient({
  maxAsyncS3: 20,     // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  s3RetryCount: 3,    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  s3RetryDelay: 1000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  multipartUploadThreshold: 20971520, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  multipartUploadSize: 15728640, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK
  s3Options: {
    accessKeyId: s3config.accessKeyId, // ä»Šå›žS3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½œæˆã—ãŸIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚­ãƒ¼
    secretAccessKey: s3config.secretAccessKey,  // ä»Šå›žS3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½œæˆã—ãŸIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ»ã‚­ãƒ¼
    region: s3config.region,
  },
});

const srcDir = path.join(__dirname, s3config.src)
// ç¶šã„ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã‚„ã€S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸæ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’paramsã§æŒ‡å®š
const params = {
  localDir: srcDir, // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€‚ãƒ‘ã‚¹ã¯ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹
  s3Params: {
    Bucket: s3config.bucket,  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã„S3ã®ãƒã‚±ãƒƒãƒˆå
    Prefix: s3config.path, // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸæ™‚ã«ä½œæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å(S3ãƒã‚±ãƒƒãƒˆã®ç›¸å¯¾ãƒ‘ã‚¹)
  },
};

const uploader = client.uploadDir(params);
uploader.on('error', function(err) {
  console.error("unable to upload:", err.stack);
});
uploader.on('progress', function() {
  console.log("progress", uploader.progressMd5Amount,
            uploader.progressAmount, uploader.progressTotal);
});
uploader.on('end', function() {
  console.log("done uploading");
});


````

## s3ãƒã‚±ãƒƒãƒˆã«ãƒ‡ãƒ—ãƒ­ã‚¤(gzipåœ§ç¸®)

gzipã«åœ§ç¸®ã—ã¦content-typeãªã©ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã¤ã‘ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚
s3ã ã‘ã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã¨ãã¯gzipåœ§ç¸®ã—ãŸã»ã†ãŒã„ã„ã®ã§ä½œæˆã€‚

s3config.jsonã¯ä¸Šè¨˜ã¨å…±é€šã§ä½¿ç”¨ã§ãã‚‹ã¯ãšã€‚

gzipDeploy.js


````javascript
const fs = require('fs');
const path = require("path");
const s3config = require("./s3config.json");
const s3 = require('s3');
const mime = require('mime');
const zlib = require('zlib');

//AWSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
const client = s3.createClient({
  maxAsyncS3: 20,     // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  s3RetryCount: 3,    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  s3RetryDelay: 1000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  multipartUploadThreshold: 20971520, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK 
  multipartUploadSize: 15728640, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK
  s3Options: {
    accessKeyId: s3config.accessKeyId, // ä»Šå›žS3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½œæˆã—ãŸIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚­ãƒ¼
    secretAccessKey: s3config.secretAccessKey,  // ä»Šå›žS3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½œæˆã—ãŸIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ»ã‚­ãƒ¼
    region: s3config.region,
  },
});

//ãƒ•ã‚©ãƒ«ãƒ€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«å–å¾—
const readSubDirSync = (folderPath) => {
  let result = [];
  const readTopDirSync = ((folderPath) => {
    let items = fs.readdirSync(folderPath);
    items = items.map((itemName) => {
      return path.join(folderPath, itemName);
    });
    items.forEach((itemPath) => {
      if (fs.statSync(itemPath).isDirectory()) {
        readTopDirSync(itemPath);
      }else{
        result.push(itemPath);
      }
    });
  });
  readTopDirSync(folderPath);
  return result;
};

const readFile = (path)=>{
  const fs = require('fs');
  return new Promise((resolve, reject)=>{
    fs.readFile(path, (err, data)=>{
      if(err) reject(err);
      resolve(data);
    });
  });
}

const putObjectToS3 = (data, src, dist)=>{

  return new Promise((resolve, reject)=>{
    const ext = path.extname(dist);
    const type = mime.getType(ext);
    var s3Params = {
      Bucket: s3config.bucket,
      Key: dist,
      Body: zlib.gzipSync(data),
      ContentEncoding:ã€€'gzip',
      ContentType: type,
    }
    const params = {
      localFile: src,
      s3Params:s3Params
    }

    var uploader = client.uploadFile(params);
    uploader.on('error', function(err) {
      console.error("unable to upload:", err.stack);
    });
    uploader.on('progress', function() {
      // console.log("progress", uploader.progressMd5Amount, uploader.progressAmount, uploader.progressTotal);
    });
    uploader.on('end', function() {
      // console.log("done uploading");
      resolve();
    });
  })
}

const uploadS3 = async(src, dist)=>{
  const data = await readFile(src);
  await putObjectToS3(data, src, dist);
  console.log(`[upload] ${src} -> ${dist}`);
}
const srcDir = path.join(__dirname, s3config.src)

const files = readSubDirSync(srcDir)
const tasks = files.map(file => {
  const dist = path.join(s3config.path, path.relative(srcDir, file));
  return uploadS3(file, dist)
})
Promise.all(tasks).then(()=>{
  console.log("complete upload!");
})
````

## gulpfile.js

gulpfileã«å„ç¨®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã®æ›¸ã„ã¦ã‚ã£ãŸã‹ã‚‰ç§»æ¤ã™ã‚Œã°æ™®é€šã®nodeã§ã‚‚ä½¿ãˆã‚‹èª¬
é©å½“ã«æ˜”ã¤ãã£ãŸgulpfileã‹ã‚‰åˆ‡ã‚Šå‡ºã—ãŸã®ã§ã“ã®è¨˜äº‹ã§ä¸€ç•ªå‹•ãä¿è¨¼ãŒãªã„ã‚‚ã®



````javascript
//----------------
// FTP
// config.js
// module.exports = {
//   host: "testtest.co.jp",
//   user: "user",
//   pass: "password",
//   parallel: 10,
//   dest: "/"
// }
//----------------
gulp.task('ftpdeploy', ()=> {
  const ftp = require('vinyl-ftp');
  const ftpconfig = require('./ftpconfig.js')

  const conn = ftp.create(ftpconfig);
  const globs = [buildPath+'**', '!'+buildPath+"api/**"];

  return gulp.src(globs, {buffer: false})
    .pipe(conn.newer(ftpconfig.dest))
    .pipe(conn.dest(ftpconfig.dest));

});


gulp.task('sftpdeploy', ()=>{
  const sftpconfig = require('./sftpconfig');
  const sftp = require('gulp-sftp');
  let config;
  switch(process.env.NODE_ENV){
    case "release":
      config = sftpconfig.release
      break
    case "stg":
      config = sftpconfig.stg
      break
    case "dev":
    default:
      config = sftpconfig.dev
    break
  }
  console.log(buildPath)
  console.log(config);
  return gulp.src(buildPath+'/**/*')
    .pipe(sftp(config));
})
//----------------
// SFTP
// sshconfig.jsã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ä½œã£ã¦gitignoreã™ã‚‹
// "dev": { host: 'hogehoge.com', port: 22, path: '/home/www/test_dev/'},
// "stg": { host: 'hogehoge.com', port: 22, path: '/home/www/test_stg/'},
// "release": { host: 'hogehoge.com', port: 22, path: '/home/www/test_release/'}
//----------------
gulp.task("sshpdeploy", ()=>{
  const rsync = require('gulp-rsync');
  const sshconfig = require('./sshconfig')

  let config;
  switch(process.env.NODE_ENV){
    case "release":
      config = sshconfig.release
      break
    case "stg":
      config = sshconfig.stg
      break
    case "dev":
    default:
      config = sshconfig.dev
    break
  }

  return gulp.src(buildPath+'**')
    .pipe(rsync({
      root: buildPath,
      hostname: config.host,
      port: config.port,
      destination: config.path
  }));
})

gulp.task('gzips3_deploy', done => {
  const AWS = require('aws-sdk');
  const path = require('path');
  const fs = require('fs');


  AWS.config.loadFromPath(path.join(__dirname,"./", "s3config.json"));
  AWS.config.update({region: 'ap-northeast-3'});

  const s3 = new AWS.S3();
  const s3bucket = "your-bucker-name"
  const base = buildPath;
  const s3base = ""

  const files = readSubDirSync(base);
  let tasks = [];
  for(let file of files){
    const fromPath = file;
    const distPath = s3base+path.relative(base, fromPath);
    tasks.push(uploadS3(s3, s3bucket, distPath, fromPath));
  }

  Promise.all(tasks).then(()=>{
    console.log("===============================");
  })

});

const readSubDirSync = (folderPath) => {
  let result = [];
  const readTopDirSync = ((folderPath) => {
    let items = fs.readdirSync(folderPath);
    items = items.map((itemName) => {
      return path.join(folderPath, itemName);
    });
    items.forEach((itemPath) => {
      if (fs.statSync(itemPath).isDirectory()) {
        readTopDirSync(itemPath);
      }else{
        result.push(itemPath);
      }
    });
  });
  readTopDirSync(folderPath);
  return result;
};

const wait = (t)=>{
  return new Promise((resolve, reject)=>{
    setTimeout(()=>{
      console.log("wait", t);
      resolve();
    }, t);
  });
}

const uploadS3 = async(s3, s3bucket, s3Path, filepath)=>{
  const data = await readFile(filepath);
  await putObjectToS3(s3, s3bucket, s3Path, data);
  console.log(`[upload] ${filepath} -> ${s3Path}`);
}

const putObjectToS3 = (s3, s3bucket, s3Path, data)=>{
  const mime = require('mime');
  const zlib = require('zlib');
  return new Promise((resolve, reject)=>{
    const ext = path.extname(s3Path);
    const type = mime.getType(ext);
    var params = {
      Bucket: s3bucket,
      Key: s3Path,
      Body: zlib.gzipSync(data),
      ContentEncoding:ã€€'gzip',
      ContentType: type,
    }
    s3.putObject(params, (err, data)=> {
      if (err){
        reject(err);
      }
      else{
        resolve();
      }
    });
  })
}

const readFile = (path)=>{
  const fs = require('fs');
  return new Promise((resolve, reject)=>{
    fs.readFile(path, (err, data)=>{
      if(err) reject(err);
      resolve(data);
    });
  });
}

//----------------
//  AWS
//  s3ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã¯
//  s3config.jsã¨ã‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œã£ã¦ignoreã—ã¦ãŠã
//  "dev": { "accessKeyId": "XXXXXXXXXXXXXXXXXXXX", "secretAccessKey": "XXXXXXXXXXXXXXX", "region": "XXXXXXXXXX", "bucket": www.hgoe.com, "path": "test_dev/" },
//  "stg": { "accessKeyId": "XXXXXXXXXXXXXXXXXXXX", "secretAccessKey": "XXXXXXXXXXXXXXX", "region": "XXXXXXXXXX", "bucket": www.hgoe.com, "path": "test_srg/" },
//  "release": { "accessKeyId": "XXXXXXXXXXXXXXXXXXXX", "secretAccessKey": "XXXXXXXXXXXXXXX", "region": "XXXXXXXXXX", "bucket": www.hgoe.com, "path": "test_release/" },
//----------------
gulp.task('s3deploy', (cb)=>{
  const AWS = require('aws-sdk');
  const async = require('async');
  const s3 = require('s3');


  const s3bucket = "my-bucker-name"
  const s3path = "test"

  AWS.config.loadFromPath(path.join(__dirname,"./", "s3config.json"));
  AWS.config.update({region: 'ap-northeast-1'});
  const awss3 = new AWS.S3();
  const options = {
    s3Client: awss3,
  };
  const client = s3.createClient(options);

  const uploadFunc = () =>{
    return new Promise((resolve, reject)=>{

      const params = {
        localDir: buildPath,
        deleteRemoved: false,
        s3Params: {
          Bucket: s3bucket,
          Prefix: "testt/"+s3path
        },
      };
      const uploader = client.uploadDir(params);
      uploader.on('error', function(err) {
        reject(err);
      });
      uploader.on('progress', function() {
        console.log("progress", uploader.progressAmount, uploader.progressTotal);
      });
      uploader.on('end', function() {
        resolve();
        console.log("done uploading");
      });
    });
  }

  uploadFunc();

